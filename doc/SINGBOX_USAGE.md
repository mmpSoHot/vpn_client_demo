# Sing-box é›†æˆä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆ sing-box æ ¸å¿ƒï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

- âœ… æ”¯æŒ Hysteria2ã€VMessã€VLESS åè®®èŠ‚ç‚¹
- âœ… è‡ªåŠ¨è§£æè®¢é˜…é“¾æ¥ä¸­çš„èŠ‚ç‚¹
- âœ… ç‚¹å‡»èŠ‚ç‚¹è‡ªåŠ¨ç”Ÿæˆé…ç½®å¹¶è¿æ¥
- âœ… æ”¯æŒèŠ‚ç‚¹åˆ‡æ¢ï¼ˆè‡ªåŠ¨åœæ­¢æ—§è¿æ¥ï¼‰
- âœ… é…ç½®æ–‡ä»¶è‡ªåŠ¨ç®¡ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡å·¥ä½œ

ç¡®ä¿ `sing-box.exe` å·²æ”¾ç½®åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼š
```
vpn_client_demo/
â”œâ”€â”€ lib/
â”œâ”€â”€ sing-box.exe  â† è¿™é‡Œ
â””â”€â”€ ...
```

### 2. ä½¿ç”¨æµç¨‹

#### æ–¹å¼ä¸€ï¼šé€šè¿‡èŠ‚ç‚¹é€‰æ‹©é¡µé¢

1. **ç™»å½•è´¦å·**
   - ç¡®ä¿å·²ç™»å½•å¹¶æœ‰æœ‰æ•ˆè®¢é˜…

2. **é€‰æ‹©èŠ‚ç‚¹**
   - åœ¨é¦–é¡µç‚¹å‡»"é€‰æ‹©èŠ‚ç‚¹"
   - ä»åº•éƒ¨å¼¹å‡ºçš„èŠ‚ç‚¹åˆ—è¡¨ä¸­é€‰æ‹©èŠ‚ç‚¹
   - **ç‚¹å‡»èŠ‚ç‚¹åä¼šè‡ªåŠ¨**ï¼š
     - ç”Ÿæˆ sing-box é…ç½®æ–‡ä»¶
     - å¯åŠ¨ sing-box è¿›ç¨‹
     - å»ºç«‹ä»£ç†è¿æ¥

3. **æŸ¥çœ‹è¿æ¥çŠ¶æ€**
   - æˆåŠŸï¼šæ˜¾ç¤ºç»¿è‰²æç¤º "âœ… å·²è¿æ¥åˆ°ï¼šxxx"
   - å¤±è´¥ï¼šæ˜¾ç¤ºçº¢è‰²æç¤º "âŒ å¯åŠ¨å¤±è´¥"

#### æ–¹å¼äºŒï¼šé€šè¿‡æµ‹è¯•é¡µé¢ï¼ˆå¼€å‘è°ƒè¯•ï¼‰

1. **æ‰“å¼€æµ‹è¯•é¡µé¢**
   - ç‚¹å‡»é¦–é¡µå³ä¸Šè§’çš„ ğŸ› å›¾æ ‡
   - è¿›å…¥ "Sing-box æµ‹è¯•" é¡µé¢

2. **ç”Ÿæˆé…ç½®**
   - ç‚¹å‡» "ç”Ÿæˆé…ç½®æ–‡ä»¶" æŒ‰é’®
   - é…ç½®æ–‡ä»¶ä¿å­˜åœ¨ `config/sing-box-config.json`

3. **å¯åŠ¨/åœæ­¢**
   - ç‚¹å‡» "å¯åŠ¨ sing-box" å¼€å§‹ä»£ç†
   - ç‚¹å‡» "åœæ­¢ sing-box" åœæ­¢ä»£ç†
   - ç‚¹å‡» "é‡å¯ sing-box" é‡æ–°åŠ è½½é…ç½®

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
lib/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ singbox_manager.dart           # Sing-box ç®¡ç†å™¨
â”‚   â””â”€â”€ node_config_converter.dart     # èŠ‚ç‚¹é…ç½®è½¬æ¢å™¨
â”œâ”€â”€ models/
â”‚   â””â”€â”€ node_model.dart                # èŠ‚ç‚¹æ•°æ®æ¨¡å‹
â””â”€â”€ pages/
    â”œâ”€â”€ node_selection_page.dart       # èŠ‚ç‚¹é€‰æ‹©é¡µé¢
    â””â”€â”€ singbox_test_page.dart         # æµ‹è¯•é¡µé¢

config/                                 # è‡ªåŠ¨åˆ›å»º
â””â”€â”€ sing-box-config.json               # é…ç½®æ–‡ä»¶
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. SingboxManager

**ä½ç½®**: `lib/utils/singbox_manager.dart`

**ä¸»è¦æ–¹æ³•**:
```dart
// ç”Ÿæˆé…ç½®å¹¶ä¿å­˜
await SingboxManager.generateConfigFromNode(
  node: nodeModel,
  mixedPort: 15808,
  enableTun: false,
);

// å¯åŠ¨ sing-box
bool started = await SingboxManager.start();

// åœæ­¢ sing-box
bool stopped = await SingboxManager.stop();

// æ£€æŸ¥è¿è¡ŒçŠ¶æ€
bool running = SingboxManager.isRunning();

// é‡å¯
bool restarted = await SingboxManager.restart();
```

### 2. NodeConfigConverter

**ä½ç½®**: `lib/utils/node_config_converter.dart`

**åŠŸèƒ½**: å°†èŠ‚ç‚¹URLè½¬æ¢ä¸º Sing-box é…ç½®

**æ”¯æŒçš„åè®®**:

#### Hysteria2
```
hysteria2://uuid@server:port?sni=xxx&security=tls&insecure=1#name
```

#### VMess
```
vmess://base64(json)
```
JSONæ ¼å¼ï¼š
```json
{
  "add": "server",
  "port": "443",
  "id": "uuid",
  "aid": "0",
  "net": "ws",
  "type": "none",
  "host": "example.com",
  "path": "/path",
  "tls": "tls"
}
```

#### VLESS
```
vless://uuid@server:port?encryption=none&security=tls&type=ws&path=/&host=xxx#name
```

### 3. é…ç½®æ–‡ä»¶æ ¼å¼

ç”Ÿæˆçš„é…ç½®æ–‡ä»¶åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

```json
{
  "log": {...},           // æ—¥å¿—é…ç½®
  "dns": {...},           // DNS é…ç½®
  "inbounds": [...],      // å…¥ç«™ï¼ˆæœ¬åœ°ç›‘å¬ï¼‰
  "outbounds": [...],     // å‡ºç«™ï¼ˆä»£ç†èŠ‚ç‚¹ï¼‰
  "route": {...}          // è·¯ç”±è§„åˆ™
}
```

## ğŸ¯ ä»£ç†é…ç½®

### æœ¬åœ°ä»£ç†ç«¯å£

- **Mixed ä»£ç†**: `127.0.0.1:15808`
  - æ”¯æŒ HTTP å’Œ SOCKS5
  - å¯åœ¨ç³»ç»Ÿä»£ç†è®¾ç½®ä¸­é…ç½®

### è·¯ç”±è§„åˆ™

- ğŸ‡¨ğŸ‡³ **å›½å†…ç›´è¿**: 
  - å›½å†…ç½‘ç«™å’ŒIPç›´æ¥è®¿é—®
  - ä½¿ç”¨å›½å†…DNSï¼ˆ223.5.5.5ï¼‰

- ğŸŒ **å›½å¤–ä»£ç†**:
  - å…¶ä»–æµé‡èµ°ä»£ç†
  - ä½¿ç”¨Google DNSï¼ˆ8.8.8.8ï¼‰

- ğŸš« **å¹¿å‘Šæ‹¦æˆª**:
  - è‡ªåŠ¨æ‹¦æˆªå¹¿å‘ŠåŸŸå

## ğŸ” è°ƒè¯•ä¿¡æ¯

### æŸ¥çœ‹æ—¥å¿—

Sing-box è¿è¡Œæ—¶ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—ï¼š

```
[sing-box] level=info msg="started" 
[sing-box] level=info msg="inbound/mixed started"
```

### é…ç½®æ–‡ä»¶ä½ç½®

```
é¡¹ç›®æ ¹ç›®å½•/config/sing-box-config.json
```

### å¸¸è§é—®é¢˜

1. **å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ `sing-box.exe` æ˜¯å¦å­˜åœ¨
   - æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—
   - ç¡®è®¤é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®

2. **è¿æ¥å¤±è´¥**
   - æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ
   - ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
   - æŸ¥çœ‹ sing-box æ—¥å¿—

3. **ç«¯å£è¢«å ç”¨**
   - ä¿®æ”¹ `mixedPort` å‚æ•°
   - æ£€æŸ¥å…¶ä»–ç¨‹åºæ˜¯å¦å ç”¨ 15808 ç«¯å£

## ğŸ“ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°åè®®æ”¯æŒ

1. åœ¨ `NodeConfigConverter` ä¸­æ·»åŠ è½¬æ¢æ–¹æ³•
2. åœ¨ `NodeModel` ä¸­æ·»åŠ åè®®è¯†åˆ«
3. æ›´æ–°é…ç½®ç”Ÿæˆé€»è¾‘

### è‡ªå®šä¹‰è·¯ç”±è§„åˆ™

ä¿®æ”¹ `NodeConfigConverter.generateFullConfig()` ä¸­çš„ `route` éƒ¨åˆ†

### ä¿®æ”¹ä»£ç†ç«¯å£

```dart
await SingboxManager.generateConfigFromNode(
  node: nodeModel,
  mixedPort: 10809, // è‡ªå®šä¹‰ç«¯å£
);
```

## ğŸ” å®‰å…¨æç¤º

- âš ï¸ é…ç½®æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆUUIDã€å¯†ç ç­‰ï¼‰
- âš ï¸ ä¸è¦å°†é…ç½®æ–‡ä»¶æäº¤åˆ°ä»£ç ä»“åº“
- âš ï¸ ç”Ÿäº§ç¯å¢ƒå»ºè®®åŠ å¯†å­˜å‚¨èŠ‚ç‚¹ä¿¡æ¯

## ğŸ“š å‚è€ƒèµ„æ–™

- [Sing-box å®˜æ–¹æ–‡æ¡£](https://sing-box.sagernet.org/)
- [é…ç½®ç¤ºä¾‹](https://github.com/SagerNet/sing-box/tree/main/docs/configuration)
- [Karing é¡¹ç›®](https://github.com/KaringX/karing)

